<!DOCTYPE html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="robots" content="noindex, nofollow, noarchive">

<style>
  /* ========================================== */
  /* HIDE WORDPRESS HEADERS/FOOTERS */
  /* ========================================== */
  header, footer, nav,
  .site-header, .site-footer,
  #masthead, #colophon,
  .header, .footer,
  #header, #footer,
  .navigation, .nav,
  #site-navigation,
  .menu, .navbar,
  .site-branding,
  .main-navigation {
    display: none !important;
  }

  body, html {
    margin: 0 !important;
    padding: 0 !important;
    overflow-x: hidden !important;
  }

  .entry-content,
  .page-content,
  article,
  main,
  .site-content {
    margin: 0 !important;
    padding: 0 !important;
    max-width: 100% !important;
  }

  /* ========================================== */
  /* VIP PASS STYLES */
  /* ========================================== */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    min-height: 100vh;
    background: linear-gradient(135deg, #0077b6 0%, #00b4d8 50%, #48cae4 100%);
    font-family: 'Inter', sans-serif;
    padding: 12px;
  }

  .container {
    max-width: 420px;
    margin: 0 auto;
  }

  .vip-header {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.25);
    border-radius: 20px;
    padding: 18px 24px;
    margin-bottom: 16px;
    text-align: center;
  }

  .vip-header-badge {
    color: rgba(255,255,255,0.75);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .vip-header-title {
    color: white;
    font-size: 24px;
    font-weight: 900;
    letter-spacing: 0.5px;
  }

  .security-clock {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(8px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50px;
    padding: 10px 20px;
    margin-bottom: 16px;
    text-align: center;
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0% {
      background: rgba(255, 100, 100, 0.4);
      border-color: rgba(255, 100, 100, 0.8);
      box-shadow: 0 0 25px rgba(255, 100, 100, 0.6);
    }
    25% {
      background: rgba(100, 200, 255, 0.4);
      border-color: rgba(100, 200, 255, 0.8);
      box-shadow: 0 0 25px rgba(100, 200, 255, 0.6);
    }
    50% {
      background: rgba(100, 255, 150, 0.4);
      border-color: rgba(100, 255, 150, 0.8);
      box-shadow: 0 0 25px rgba(100, 255, 150, 0.6);
    }
    75% {
      background: rgba(255, 200, 100, 0.4);
      border-color: rgba(255, 200, 100, 0.8);
      box-shadow: 0 0 25px rgba(255, 200, 100, 0.6);
    }
    100% {
      background: rgba(255, 100, 100, 0.4);
      border-color: rgba(255, 100, 100, 0.8);
      box-shadow: 0 0 25px rgba(255, 100, 100, 0.6);
    }
  }

  .clock-time {
    color: white;
    font-size: 18px;
    font-weight: 900;
    letter-spacing: 2px;
    text-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }

  .card {
    background: white;
    border-radius: 32px;
    padding: 35px 28px;
    box-shadow: 0 25px 60px rgba(0, 55, 100, 0.25);
  }

  .card-badge {
    background: linear-gradient(135deg, #0077b6, #00b4d8);
    color: white;
    padding: 6px 18px;
    border-radius: 50px;
    font-size: 11px;
    font-weight: 800;
    letter-spacing: 2px;
    text-transform: uppercase;
    display: inline-block;
    margin-bottom: 16px;
  }

  .status-active {
    background: #ecfdf5;
    color: #059669;
    border: 2px solid #6ee7b7;
    padding: 8px 20px;
    border-radius: 50px;
    font-size: 13px;
    font-weight: 800;
    display: inline-block;
    letter-spacing: 1px;
    margin-bottom: 16px;
  }

  .status-dark {
    background: #f3f4f6;
    color: #6b7280;
    border: 2px solid #d1d5db;
    padding: 8px 20px;
    border-radius: 50px;
    font-size: 13px;
    font-weight: 800;
    display: inline-block;
    letter-spacing: 1px;
    margin-bottom: 16px;
  }

  .code-box {
    background: linear-gradient(135deg, #0077b6, #00b4d8);
    border-radius: 20px;
    padding: 25px 20px;
    margin: 20px 0;
    text-align: center;
  }

  .code-box.dark {
    background: linear-gradient(135deg, #9ca3af, #6b7280);
  }

  .code-label {
    color: rgba(255,255,255,0.75);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .code-value {
    font-size: 72px;
    font-weight: 900;
    color: white;
    letter-spacing: 6px;
    line-height: 1;
    text-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  .code-value.dark {
    opacity: 0.4;
    filter: blur(4px);
  }

  .punch-card {
    background: #f0fbff;
    border: 2px solid #e0f4f8;
    border-radius: 16px;
    padding: 20px;
    margin: 20px 0;
    text-align: center;
  }

  .punch-card-title {
    font-size: 12px;
    font-weight: 800;
    color: #0077b6;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
  }

  .punch-circles {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 12px;
    font-size: 28px;
    line-height: 1;
  }

  .punch-progress-text {
    font-size: 14px;
    font-weight: 700;
    color: #0077b6;
    margin-bottom: 6px;
  }

  .punch-next-reward {
    font-size: 12px;
    color: #666;
  }

  .reward-badge {
    border-radius: 16px;
    padding: 20px;
    margin: 16px 0;
    text-align: center;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .reward-badge:active {
    transform: scale(0.95);
  }

  .reward-badge.tier1 {
    background: linear-gradient(135deg, #a78bfa, #8b5cf6);
    box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
  }

  .reward-badge.tier2 {
    background: linear-gradient(135deg, #60a5fa, #3b82f6);
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
  }

  .reward-badge.tier3 {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
  }

  .reward-badge-title {
    color: white;
    font-size: 20px;
    font-weight: 900;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .reward-badge-desc {
    color: rgba(255,255,255,0.9);
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 12px;
  }

  .reward-badge-tap {
    color: rgba(255,255,255,0.8);
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    border: 2px solid rgba(255,255,255,0.4);
    border-radius: 50px;
    padding: 6px 16px;
    display: inline-block;
  }

  .btn {
    width: 100%;
    padding: 20px;
    border: none;
    border-radius: 50px;
    font-weight: 900;
    font-size: 17px;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    letter-spacing: 1px;
    transition: transform 0.1s, box-shadow 0.1s;
  }

  .btn-primary {
    background: linear-gradient(135deg, #0077b6, #00b4d8);
    color: white;
    box-shadow: 0 6px 0 #005f8a, 0 10px 20px rgba(0, 119, 182, 0.3);
  }

  .btn-primary:active {
    transform: translateY(3px);
    box-shadow: 0 3px 0 #005f8a;
  }

  .form-group { margin-bottom: 20px; }

  .form-label {
    font-size: 11px;
    font-weight: 800;
    color: #0077b6;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    display: block;
    margin-bottom: 6px;
  }

  .form-input {
    width: 100%;
    padding: 15px 18px;
    border: 2px solid #e0f4f8;
    border-radius: 14px;
    font-size: 16px;
    font-family: 'Inter', sans-serif;
    background: #f0fbff;
    color: #03045e;
    outline: none;
    transition: border-color 0.2s;
    box-sizing: border-box;
  }

  .form-input:focus {
    border-color: #00b4d8;
    background: white;
  }

  .form-row { display: flex; gap: 12px; }
  .form-row .form-group { flex: 1; }

  .page-title {
    font-size: 28px;
    font-weight: 900;
    color: #03045e;
    margin-bottom: 8px;
    text-align: center;
  }

  .page-subtitle {
    font-size: 14px;
    color: #90e0ef;
    font-weight: 600;
    text-align: center;
    margin-bottom: 30px;
  }

  .phone-display {
    background: #f0fbff;
    border: 2px solid #00b4d8;
    border-radius: 16px;
    padding: 20px;
    margin: 20px 0;
    text-align: center;
  }

  .phone-display-number {
    font-size: 32px;
    font-weight: 900;
    color: #0077b6;
    letter-spacing: 2px;
  }

  .loading {
    text-align: center;
    padding: 40px 20px;
  }

  .loading-spinner {
    font-size: 48px;
    animation: spin 1.5s linear infinite;
    display: block;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .loading-text {
    color: #0077b6;
    font-size: 16px;
    font-weight: 700;
    margin-top: 16px;
  }

  .text-center { text-align: center; }
  .mb-16 { margin-bottom: 16px; }
  .mt-20 { margin-top: 20px; }

  .wave-divider {
    text-align: center;
    font-size: 20px;
    margin: 16px 0;
    opacity: 0.3;
    letter-spacing: 6px;
  }


  /* ========================================== */
  /* PIN KEYPAD STYLES */
  /* ========================================== */
  .pin-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .pin-modal {
    background: white;
    border-radius: 28px;
    padding: 32px 24px;
    width: 100%;
    max-width: 340px;
    text-align: center;
    box-shadow: 0 30px 60px rgba(0,0,0,0.4);
  }

  .pin-title {
    font-size: 13px;
    font-weight: 800;
    color: #0077b6;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .pin-reward-desc {
    font-size: 16px;
    font-weight: 700;
    color: #03045e;
    margin-bottom: 24px;
  }

  .pin-dots {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-bottom: 24px;
  }

  .pin-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 3px solid #0077b6;
    background: white;
    transition: background 0.1s;
  }

  .pin-dot.filled {
    background: #0077b6;
  }

  .pin-dot.error {
    border-color: #dc2626;
    background: #dc2626;
    animation: shake 0.3s ease;
  }

  @keyframes shake {
    0%   { transform: translateX(0); }
    25%  { transform: translateX(-6px); }
    50%  { transform: translateX(6px); }
    75%  { transform: translateX(-6px); }
    100% { transform: translateX(0); }
  }

  .pin-keypad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }

  .pin-key {
    background: #f0fbff;
    border: 2px solid #e0f4f8;
    border-radius: 16px;
    padding: 20px 10px;
    font-size: 26px;
    font-weight: 900;
    color: #03045e;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    transition: background 0.1s, transform 0.1s;
    -webkit-tap-highlight-color: transparent;
  }

  .pin-key:active {
    background: #0077b6;
    color: white;
    transform: scale(0.94);
  }

  .pin-key.clear {
    background: #fef2f2;
    border-color: #fecaca;
    color: #dc2626;
    font-size: 18px;
  }

  .pin-key.confirm {
    background: linear-gradient(135deg, #0077b6, #00b4d8);
    border-color: #0077b6;
    color: white;
    font-size: 18px;
  }

  .pin-key.zero {
    grid-column: 2;
  }

  .pin-error-msg {
    font-size: 13px;
    font-weight: 700;
    color: #dc2626;
    min-height: 20px;
    margin-bottom: 12px;
  }

  .pin-cancel {
    font-size: 13px;
    color: #999;
    font-weight: 600;
    cursor: pointer;
    text-decoration: underline;
  }

  .hidden { display: none !important; }

  #qr-reader {
    width: 100%;
    border-radius: 16px;
    overflow: hidden;
    margin: 20px 0;
  }
</style>

<div class="container">

  <div class="vip-header">
    <div class="vip-header-badge">üåä Grand Strand VIP</div>
    <div class="vip-header-title" id="headerTitle">Loading...</div>
  </div>

  <div id="securityClock" class="security-clock hidden">
    <div class="clock-time" id="clockTime">00:00:00</div>
  </div>

  <div class="card">
    <div class="text-center mb-16">
      <!-- FIX 5: id added so JS can set this dynamically from URL bar_id param -->
      <span class="card-badge" id="cardBadge">GRAND STRAND VIP</span>
    </div>

    <!-- VIEW: Loading -->
    <div id="viewLoading" class="loading">
      <span class="loading-spinner">üîÑ</span>
      <div class="loading-text">Loading your pass...</div>
    </div>

    <!-- VIEW: Registration -->
    <div id="viewRegistration" class="hidden">
      <h2 class="page-title">Get Your VIP Pass</h2>
      <p class="page-subtitle">Activate your Member ID</p>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">First Name</label>
          <input type="text" id="regFirstName" class="form-input" placeholder="John" maxlength="20">
        </div>
        <div class="form-group">
          <label class="form-label">Last Name</label>
          <input type="text" id="regLastName" class="form-input" placeholder="Smith" maxlength="20">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Phone Number</label>
        <input type="tel" id="regPhone" class="form-input" placeholder="(843) 555-1234" maxlength="14">
      </div>

      <div class="wave-divider">~ ~ ~ ~ ~</div>

      <button class="btn btn-primary" onclick="handleRegistration()">
        ACTIVATE MY PASS
      </button>
    </div>

    <!-- VIEW: Active Pass -->
    <div id="viewActive" class="hidden">
      <div class="text-center mb-16">
        <span class="status-active">‚úÖ PASS ACTIVE</span>
      </div>

      <div class="code-box">
        <div class="code-label">Your VIP Code</div>
        <div class="code-value" id="codeValue">----</div>
      </div>

      <div class="punch-card">
        <div class="punch-card-title">üéØ Punch Card Progress</div>
        <div class="punch-circles" id="punchCircles">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
        <div class="punch-progress-text" id="punchProgress">0 of 5 visits</div>
        <div class="punch-next-reward" id="punchNextReward">Next reward: Free Appetizer</div>
      </div>

      <div id="rewardBadges"></div>

    <!-- PIN OVERLAY -->
    <div id="pinOverlay" class="pin-overlay hidden">
      <div class="pin-modal">
        <div class="pin-title">Staff Verification Required</div>
        <div class="pin-reward-desc" id="pinRewardDesc">Free Appetizer</div>
        <div class="pin-dots">
          <div class="pin-dot" id="dot0"></div>
          <div class="pin-dot" id="dot1"></div>
          <div class="pin-dot" id="dot2"></div>
          <div class="pin-dot" id="dot3"></div>
        </div>
        <div class="pin-error-msg" id="pinErrorMsg"></div>
        <div class="pin-keypad">
          <button class="pin-key" onclick="pinKey('1')">1</button>
          <button class="pin-key" onclick="pinKey('2')">2</button>
          <button class="pin-key" onclick="pinKey('3')">3</button>
          <button class="pin-key" onclick="pinKey('4')">4</button>
          <button class="pin-key" onclick="pinKey('5')">5</button>
          <button class="pin-key" onclick="pinKey('6')">6</button>
          <button class="pin-key" onclick="pinKey('7')">7</button>
          <button class="pin-key" onclick="pinKey('8')">8</button>
          <button class="pin-key" onclick="pinKey('9')">9</button>
          <button class="pin-key clear" onclick="pinClear()">CLR</button>
          <button class="pin-key zero" onclick="pinKey('0')">0</button>
          <button class="pin-key confirm" onclick="pinConfirm()">OK</button>
        </div>
        <div class="pin-cancel" onclick="pinCancel()">Cancel</div>
      </div>
    </div>

      <p style="text-align: center; font-size: 13px; color: #666; margin-top: 16px;">
        Show this code to your server when ordering
      </p>
    </div>

    <!-- VIEW: Dark Pass -->
    <div id="viewDark" class="hidden">
      <div class="text-center mb-16">
        <span class="status-dark">‚è∞ PASS EXPIRED</span>
      </div>

      <div class="code-box dark">
        <div class="code-label">Your VIP Code</div>
        <div class="code-value dark" id="codeValueDark">----</div>
      </div>

      <div class="punch-card">
        <div class="punch-card-title">üéØ Punch Card Progress</div>
        <div class="punch-circles" id="punchCirclesDark">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
        <div class="punch-progress-text" id="punchProgressDark">0 of 5 visits</div>
      </div>

      <p style="text-align: center; font-size: 14px; color: #666; margin: 20px 0; line-height: 1.6;">
        Visit the bar and scan the QR code to reactivate your pass
      </p>

      <button class="btn btn-primary" onclick="startQRScan()">
        üì∑ SCAN QR TO WAKE UP
      </button>
    </div>

    <!-- VIEW: Phone Confirmation -->
    <div id="viewPhoneConfirm" class="hidden" style="text-align: center;">
      <h2 class="page-title">Welcome Back!</h2>
      <p class="page-subtitle">Let's restore your pass</p>

      <div class="phone-display">
        <p style="font-size: 13px; color: #0077b6; font-weight: 700; margin-bottom: 8px;">IS THIS YOU?</p>
        <div class="phone-display-number" id="confirmPhone">---</div>
      </div>

      <button class="btn btn-primary" onclick="confirmPhoneRestore()">
        ‚úÖ YES, THAT'S ME
      </button>

      <p style="text-align: center; font-size: 12px; color: #999; margin-top: 16px;">
        Or <a href="#" onclick="showRegistration(); return false;" style="color: #0077b6; font-weight: 700;">register a new pass</a>
      </p>
    </div>

    <!-- VIEW: QR Scanner -->
    <div id="viewScanner" class="hidden">
      <h2 class="page-title">Scan Bar's QR Code</h2>
      <p class="page-subtitle">Point camera at the QR code posted at the bar</p>
      <div id="qr-reader"></div>
      <div id="scanStatus" style="text-align: center; color: #0077b6; font-weight: 700; font-size: 14px;">
        üì∑ Starting camera...
      </div>
      <button class="btn btn-primary mt-20" onclick="cancelScan()" style="background: #6b7280; box-shadow: 0 6px 0 #4b5563;">
        ‚Üê BACK
      </button>
    </div>

  </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
// ============================================
// CONFIGURATION
// ============================================
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx5A_LYlaGPiXsHuBxEWpsB5pF9_GCB8xrEclxpm2ieoK6zf_VRm9EzbnIZNJz8hmpVsQ/exec";

// ============================================
// DEFAULT CONFIG (used if Google Sheets unreachable)
// ============================================
const DEFAULT_CONFIG = {
  expirationHours: 12,
  dailyLimit: 1,
  tier1Visits: 5,
  tier1Reward: 'Free Appetizer (up to $12)',
  tier2Visits: 10,
  tier2Reward: 'Free Well Drink',
  tier3Visits: 20,
  tier3Reward: '10% Off Entire Check',
  redemptionPin: '0000'
};

// ============================================
// STATE
// FIX 3: Added visitsByOwner and lastVisitByBar
// replacing single global totalVisits
// ============================================
let currentState = {
  phone: null,
  code: null,
  firstName: null,
  lastName: null,
  lastScanTimestamp: null,
  lastScanBar: null,
  isActive: false,
  barOwnerID: null,
  barID: null,
  config: { ...DEFAULT_CONFIG },
  visitsByOwner: {},    // { 'johns-bars': 5 }  ‚Äî per-owner punch counts
  lastVisitByBar: {}    // { 'marshwalk': 1234567890 } ‚Äî per-bar timestamps
};

let qrScanner = null;
let clockInterval = null;

// ============================================
// SAFE FETCH (with timeout)
// ============================================
async function safeFetch(url, options = {}, timeoutMs = 5000) {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), timeoutMs);
  try {
    const response = await fetch(url, { ...options, signal: controller.signal });
    clearTimeout(timeout);
    return response;
  } catch (err) {
    clearTimeout(timeout);
    throw err;
  }
}

// ============================================
// PAGE INITIALIZATION
// ============================================
document.addEventListener("DOMContentLoaded", function() {
  document.getElementById('regPhone').addEventListener('input', formatPhoneNumber);
  initializePage();
});

function formatPhoneNumber(e) {
  let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
  e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
}

async function initializePage() {
  const safetyTimer = setTimeout(() => {
    console.log('Safety timer triggered - showing registration');
    showRegistration();
  }, 6000);

  try {
    const urlParams = new URLSearchParams(window.location.search);
    const barOwner = urlParams.get('bar_owner');
    const barId = urlParams.get('bar_id');

    if (barOwner) currentState.barOwnerID = barOwner;
    if (barId) currentState.barID = barId;

    // FIX 5: Set card badge dynamically from bar_id URL param
    updateCardBadge();

    // FIX 1: loadConfig now sends a POST request
    await loadConfig();

    const savedData = loadFromLocalStorage();

    if (savedData) {
      currentState = { ...currentState, ...savedData };
      checkPassStatus();
    } else {
      const urlPhone = urlParams.get('ph');
      if (urlPhone) {
        showPhoneConfirmation(urlPhone);
      } else {
        showRegistration();
      }
    }

  } catch (err) {
    console.error('Init error:', err);
    showRegistration();
  } finally {
    clearTimeout(safetyTimer);
  }
}

// ============================================
// FIX 5: Dynamic card badge
// ============================================
function updateCardBadge() {
  const barID = currentState.barID;
  const badgeEl = document.getElementById('cardBadge');
  if (!badgeEl) return;
  if (barID) {
    badgeEl.innerText = barID.replace(/-/g, ' ').toUpperCase() + ' VIP';
  } else {
    badgeEl.innerText = 'GRAND STRAND VIP';
  }
}

// ============================================
// FIX 3: localStorage ‚Äî per-owner and per-bar keys
// ============================================
function loadFromLocalStorage() {
  try {
    const phone = localStorage.getItem('vip_phone');
    const code = localStorage.getItem('vip_code');
    const firstName = localStorage.getItem('vip_fname');
    const lastName = localStorage.getItem('vip_lname');
    const lastScan = localStorage.getItem('vip_last_scan');

    if (!phone || !code) return null;

    // Build visitsByOwner from stored keys
    const visitsByOwner = {};
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('vip_total_visits_')) {
        const ownerID = key.replace('vip_total_visits_', '');
        visitsByOwner[ownerID] = parseInt(localStorage.getItem(key) || '0');
      }
    }

    // Build lastVisitByBar from stored keys
    const lastVisitByBar = {};
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('vip_last_visit_')) {
        const barID = key.replace('vip_last_visit_', '');
        lastVisitByBar[barID] = parseInt(localStorage.getItem(key) || '0');
      }
    }

    // MIGRATION: convert old single vip_total_visits key to new format
    const oldVisits = localStorage.getItem('vip_total_visits');
    if (oldVisits && currentState.barOwnerID) {
      const ownerID = currentState.barOwnerID;
      if (!visitsByOwner[ownerID]) {
        visitsByOwner[ownerID] = parseInt(oldVisits);
        localStorage.setItem('vip_total_visits_' + ownerID, oldVisits);
      }
      localStorage.removeItem('vip_total_visits');
      console.log('Migrated old visit count to per-owner format:', ownerID);
    }

    return {
      phone,
      code,
      firstName,
      lastName,
      lastScanTimestamp: lastScan ? parseInt(lastScan) : null,
      visitsByOwner,
      lastVisitByBar
    };

  } catch (err) {
    console.error('localStorage load error:', err);
  }
  return null;
}

function saveToLocalStorage() {
  try {
    localStorage.setItem('vip_phone', currentState.phone);
    localStorage.setItem('vip_code', currentState.code);
    localStorage.setItem('vip_fname', currentState.firstName);
    localStorage.setItem('vip_lname', currentState.lastName);
    localStorage.setItem('vip_last_scan', currentState.lastScanTimestamp);

    // Save per-owner visit counts
    if (currentState.visitsByOwner) {
      for (const ownerID in currentState.visitsByOwner) {
        localStorage.setItem('vip_total_visits_' + ownerID, currentState.visitsByOwner[ownerID]);
      }
    }

    // Save per-bar last visit timestamps
    if (currentState.lastVisitByBar) {
      for (const barID in currentState.lastVisitByBar) {
        localStorage.setItem('vip_last_visit_' + barID, currentState.lastVisitByBar[barID]);
      }
    }
  } catch (err) {
    console.error('localStorage save error:', err);
  }
}

// ============================================
// VIEW MANAGEMENT
// ============================================
function showView(viewId) {
  ['viewLoading', 'viewRegistration', 'viewActive', 'viewDark', 'viewPhoneConfirm', 'viewScanner'].forEach(id => {
    document.getElementById(id).classList.add('hidden');
  });
  document.getElementById(viewId).classList.remove('hidden');
}

function showRegistration() {
  document.getElementById('headerTitle').innerText = 'Join The VIP Club';
  document.getElementById('securityClock').classList.add('hidden');
  stopClock();
  showView('viewRegistration');
}

function showPhoneConfirmation(phone) {
  document.getElementById('headerTitle').innerText = 'Welcome Back!';
  document.getElementById('confirmPhone').innerText = formatPhone(phone);
  currentState.phone = phone;
  document.getElementById('securityClock').classList.add('hidden');
  stopClock();
  showView('viewPhoneConfirm');
}

function showActivePass() {
  const name = (currentState.firstName || '') + ' ' + (currentState.lastName || '');
  document.getElementById('headerTitle').innerText = name.trim() || 'VIP Member';
  document.getElementById('codeValue').innerText = currentState.code || '----';
  document.getElementById('securityClock').classList.remove('hidden');
  updateCardBadge();
  startClock();
  renderPunchCard();
  showView('viewActive');
}

function showDarkPass() {
  const name = (currentState.firstName || '') + ' ' + (currentState.lastName || '');
  document.getElementById('headerTitle').innerText = name.trim() || 'VIP Member';
  document.getElementById('codeValueDark').innerText = currentState.code || '----';
  document.getElementById('securityClock').classList.add('hidden');
  stopClock();
  renderDarkPunchCard();
  showView('viewDark');
}

// ============================================
// PASS STATUS CHECK
// ============================================
function checkPassStatus() {
  const now = Date.now();
  const expirationMs = (currentState.config.expirationHours || 12) * 60 * 60 * 1000;
  const lastScan = currentState.lastScanTimestamp;
  const timeSinceScan = lastScan ? now - parseInt(lastScan) : Infinity;

  if (timeSinceScan < expirationMs) {
    showActivePass();
  } else {
    showDarkPass();
  }
}

// ============================================
// FIX 3: Punch card rendering ‚Äî reads per-owner count
// ============================================
function renderPunchCard() {
  const config = currentState.config;

  // Read visits for current bar's owner only
  const ownerID = currentState.barOwnerID || 'unknown';
  const visits = (currentState.visitsByOwner && currentState.visitsByOwner[ownerID]) || 0;

  let nextVisits = config.tier1Visits;
  let nextReward = config.tier1Reward;

  if (visits >= config.tier3Visits) {
    nextVisits = config.tier3Visits;
    nextReward = config.tier3Reward;
  } else if (visits >= config.tier2Visits) {
    nextVisits = config.tier3Visits;
    nextReward = config.tier3Reward;
  } else if (visits >= config.tier1Visits) {
    nextVisits = config.tier2Visits;
    nextReward = config.tier2Reward;
  }

  let circles = '';
  for (let i = 0; i < nextVisits; i++) {
    circles += i < visits ? '‚≠ê' : '‚òÜ';
  }

  document.getElementById('punchCircles').innerText = circles;
  document.getElementById('punchProgress').innerText = `${visits} of ${nextVisits} visits`;
  document.getElementById('punchNextReward').innerText = `Next: ${nextReward}`;

  renderBadges(visits);
}

function renderDarkPunchCard() {
  const config = currentState.config;
  const ownerID = currentState.barOwnerID || 'unknown';
  const visits = (currentState.visitsByOwner && currentState.visitsByOwner[ownerID]) || 0;
  const nextVisits = config.tier1Visits;

  let circles = '';
  for (let i = 0; i < nextVisits; i++) {
    circles += i < visits ? '‚≠ê' : '‚òÜ';
  }

  document.getElementById('punchCirclesDark').innerText = circles;
  document.getElementById('punchProgressDark').innerText = `${visits} of ${nextVisits} visits`;
}

// ============================================
// FIX 3: renderBadges uses passed-in visit count
// ============================================
function renderBadges(visits) {
  if (visits === undefined) {
    const ownerID = currentState.barOwnerID || 'unknown';
    visits = (currentState.visitsByOwner && currentState.visitsByOwner[ownerID]) || 0;
  }

  const config = currentState.config;
  const container = document.getElementById('rewardBadges');
  container.innerHTML = '';

  const tiers = [
    { key: 'TIER1', visits: config.tier1Visits, reward: config.tier1Reward, class: 'tier1', icon: 'üéâ', label: 'Bronze Reward' },
    { key: 'TIER2', visits: config.tier2Visits, reward: config.tier2Reward, class: 'tier2', icon: '‚≠ê', label: 'Silver Reward' },
    { key: 'TIER3', visits: config.tier3Visits, reward: config.tier3Reward, class: 'tier3', icon: 'üëë', label: 'Gold Reward' }
  ];

  tiers.forEach(tier => {
    if (visits >= tier.visits) {
      const el = document.createElement('div');
      el.className = `reward-badge ${tier.class}`;
      el.innerHTML = `
        <div class="reward-badge-title">${tier.icon} ${tier.label} Unlocked!</div>
        <div class="reward-badge-desc">${tier.reward}</div>
        <div class="reward-badge-tap">üëÜ SERVER TAP TO REDEEM</div>
      `;
      el.onclick = () => redeemReward(tier.key, tier.reward);
      container.appendChild(el);
    }
  });
}

// ============================================
// REDEMPTION PIN SYSTEM
// ============================================
let pinState = {
  entered: '',
  tier: null,
  rewardDesc: null,
  attempts: 0,
  locked: false,
  lockTimeout: null
};

function redeemReward(tier, rewardDesc) {
  if (pinState.locked) {
    alert('PIN entry is locked. Please wait 60 seconds and try again.');
    return;
  }
  pinState.entered = '';
  pinState.tier = tier;
  pinState.rewardDesc = rewardDesc;
  document.getElementById('pinRewardDesc').innerText = rewardDesc;
  document.getElementById('pinErrorMsg').innerText = '';
  updatePinDots();
  document.getElementById('pinOverlay').classList.remove('hidden');
}

function pinKey(digit) {
  if (pinState.entered.length >= 4) return;
  pinState.entered += digit;
  updatePinDots();
  if (pinState.entered.length === 4) {
    setTimeout(pinConfirm, 200);
  }
}

function pinClear() {
  pinState.entered = '';
  updatePinDots();
  document.getElementById('pinErrorMsg').innerText = '';
}

function pinCancel() {
  pinState.entered = '';
  pinState.tier = null;
  pinState.rewardDesc = null;
  document.getElementById('pinOverlay').classList.add('hidden');
}

function updatePinDots() {
  for (let i = 0; i < 4; i++) {
    const dot = document.getElementById('dot' + i);
    dot.classList.remove('filled', 'error');
    if (i < pinState.entered.length) dot.classList.add('filled');
  }
}

function pinError() {
  for (let i = 0; i < 4; i++) {
    document.getElementById('dot' + i).classList.add('error');
  }
  setTimeout(() => {
    pinState.entered = '';
    updatePinDots();
  }, 600);
}

function pinConfirm() {
  if (pinState.entered.length < 4) {
    document.getElementById('pinErrorMsg').innerText = 'Enter all 4 digits';
    return;
  }

  const correctPin = (currentState.config && currentState.config.redemptionPin) || '0000';

  if (pinState.entered === correctPin) {
    // PIN correct ‚Äî redeem reward
    pinState.attempts = 0;
    document.getElementById('pinOverlay').classList.add('hidden');

    const ownerID = currentState.barOwnerID || 'unknown';
    if (!currentState.visitsByOwner) currentState.visitsByOwner = {};
    const visitsAtRedemption = currentState.visitsByOwner[ownerID] || 0;
    currentState.visitsByOwner[ownerID] = 0;
    saveToLocalStorage();
    renderPunchCard();

    const formData = new URLSearchParams({
      type: 'REDEEM_REWARD',
      phone: currentState.phone,
      code: currentState.code,
      tier: pinState.tier,
      barID: currentState.barID || 'unknown',
      ownerID: ownerID,
      visitsAtRedemption: visitsAtRedemption,
      timestamp: Date.now()
    });

    fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData })
      .catch(err => console.log('Redemption log failed:', err));

    alert('Reward redeemed! Punch card has been reset.');
    pinState.tier = null;
    pinState.rewardDesc = null;

  } else {
    // Wrong PIN
    pinState.attempts++;
    pinError();

    if (pinState.attempts >= 3) {
      pinState.locked = true;
      pinState.entered = '';
      document.getElementById('pinOverlay').classList.add('hidden');
      document.getElementById('pinErrorMsg').innerText = '';
      alert('Too many incorrect attempts. PIN entry locked for 60 seconds.');
      pinState.lockTimeout = setTimeout(() => {
        pinState.locked = false;
        pinState.attempts = 0;
        console.log('PIN lock cleared');
      }, 60000);
    } else {
      const remaining = 3 - pinState.attempts;
      document.getElementById('pinErrorMsg').innerText = 'Incorrect PIN ‚Äî ' + remaining + ' attempt' + (remaining === 1 ? '' : 's') + ' remaining';
    }
  }
}

// ============================================
// SECURITY CLOCK
// ============================================
function startClock() {
  stopClock();
  updateClock();
  clockInterval = setInterval(updateClock, 1000);
}

function stopClock() {
  if (clockInterval) {
    clearInterval(clockInterval);
    clockInterval = null;
  }
}

function updateClock() {
  const now = new Date();
  const hours = now.getHours() % 12 || 12;
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const seconds = String(now.getSeconds()).padStart(2, '0');
  const ampm = now.getHours() >= 12 ? 'PM' : 'AM';
  const el = document.getElementById('clockTime');
  if (el) el.innerText = `‚è∞ ${hours}:${minutes}:${seconds} ${ampm}`;
}

// ============================================
// FIX 1: loadConfig now sends POST request
// ============================================
async function loadConfig() {
  try {
    const barOwner = currentState.barOwnerID || 'default';
    const barID = currentState.barID || 'default';

    const formData = new URLSearchParams({
      type: 'GET_CONFIG',
      bar_owner: barOwner,
      bar_id: barID
    });

    const response = await safeFetch(
      GOOGLE_SCRIPT_URL,
      { method: 'POST', body: formData },
      4000
    );

    const data = await response.json();

    if (data.status === 'SUCCESS' && data.config) {
      currentState.config = data.config;
      console.log('Config loaded from sheet:', data.config);
    }
  } catch (err) {
    console.log('Config load failed, using defaults:', err.message);
    currentState.config = { ...DEFAULT_CONFIG };
  }
}

// ============================================
// handleRegistration ‚Äî checks backend first, then shows pass
// New customer: create account, show pass instantly
// Returning customer (wiped cache): restore existing pass
// ============================================
async function handleRegistration() {
  const firstName = document.getElementById('regFirstName').value.trim();
  const lastName = document.getElementById('regLastName').value.trim();
  const phone = document.getElementById('regPhone').value.replace(/\D/g, '');

  if (!firstName || !lastName) {
    alert('Please enter your first and last name');
    return;
  }

  if (phone.length !== 10) {
    alert('Please enter a valid 10-digit phone number');
    return;
  }

  // Show loading state while we check
  const btn = document.querySelector('#viewRegistration .btn-primary');
  btn.disabled = true;
  btn.innerText = 'Checking...';

  const ownerID = currentState.barOwnerID || 'unknown';
  if (!currentState.visitsByOwner) currentState.visitsByOwner = {};
  if (!currentState.lastVisitByBar) currentState.lastVisitByBar = {};

  const code = firstName.charAt(0).toUpperCase() + Math.floor(1000 + Math.random() * 9000);

  currentState.phone = phone;
  currentState.firstName = firstName;
  currentState.lastName = lastName;
  currentState.lastScanTimestamp = Date.now();
  currentState.isActive = true;

  const formData = new URLSearchParams({
    type: 'NEW_REGISTRATION',
    phone: phone,
    firstName: firstName,
    lastName: lastName,
    code: code,
    ownerID: ownerID,
    barID: currentState.barID || 'unknown',
    timestamp: Date.now()
  });

  try {
    const response = await safeFetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData }, 8000);
    const data = await response.json();

    if (data.status === 'ALREADY_EXISTS') {
      // Returning customer ‚Äî restore their existing pass
      console.log('Returning customer ‚Äî restoring existing pass');
      currentState.code = data.code;
      const existingOwnerID = data.ownerID || ownerID;
      if (!currentState.visitsByOwner[existingOwnerID]) {
        currentState.visitsByOwner[existingOwnerID] = 0;
      }
      saveToLocalStorage();
      showActivePass();
      return;
    }

    // New customer ‚Äî use generated code
    currentState.code = code;
    currentState.visitsByOwner[ownerID] = 1;
    currentState.lastVisitByBar[currentState.barID || 'unknown'] = Date.now();
    saveToLocalStorage();
    showActivePass();

  } catch (err) {
    // Backend unreachable ‚Äî proceed with generated code, sync later
    console.log('Backend unreachable, proceeding locally:', err.message);
    currentState.code = code;
    currentState.visitsByOwner[ownerID] = 1;
    currentState.lastVisitByBar[currentState.barID || 'unknown'] = Date.now();
    saveToLocalStorage();
    showActivePass();
  }
}

// ============================================
// PHONE CONFIRMATION / RESTORE
// ============================================
async function confirmPhoneRestore() {
  showView('viewLoading');

  try {
    const response = await safeFetch(
      `${GOOGLE_SCRIPT_URL}?type=LOOKUP_BY_PHONE&phone=${currentState.phone}`,
      {},
      6000
    );

    const data = await response.json();

    if (data.status === 'SUCCESS') {
      currentState.code = data.customer.code;
      currentState.firstName = data.customer.firstName;
      currentState.lastName = data.customer.lastName;
      currentState.lastScanTimestamp = data.customer.lastScan
        ? new Date(data.customer.lastScan).getTime() : null;

      // Restore visit count for their owner
      const restoredOwnerID = data.customer.ownerID || currentState.barOwnerID || 'unknown';
      if (!currentState.visitsByOwner) currentState.visitsByOwner = {};
      currentState.visitsByOwner[restoredOwnerID] = data.customer.totalScans || 0;

      saveToLocalStorage();
      checkPassStatus();
    } else {
      alert('No account found for this number. Please register.');
      showRegistration();
    }
  } catch (err) {
    console.error('Restore failed:', err);
    alert('Could not connect. Please try again.');
    showRegistration();
  }
}

// ============================================
// QR SCANNING
// ============================================
function startQRScan() {
  showView('viewScanner');

  const html5QrCode = new Html5Qrcode("qr-reader");
  qrScanner = html5QrCode;

  html5QrCode.start(
    { facingMode: "environment" },
    {
      fps: 10,
      qrbox: { width: 250, height: 250 },
      aspectRatio: 1.0
    },
    async (decodedText) => {
      console.log('QR Code detected:', decodedText);
      document.getElementById('scanStatus').innerHTML = '<span style="color:#059669;">‚úÖ QR Code Detected!</span>';

      try {
        const url = new URL(decodedText);
        const scannedBarOwner = url.searchParams.get('bar_owner');
        const scannedBarID = url.searchParams.get('bar_id');

        console.log('Parsed:', { scannedBarOwner, scannedBarID });

        html5QrCode.stop();
        qrScanner = null;

        await logVisit(scannedBarOwner, scannedBarID);
      } catch (err) {
        console.error('QR parse error:', err);
        document.getElementById('scanStatus').innerHTML = '<span style="color:#dc2626;">‚ùå Invalid QR code format. Expected URL with bar_owner and bar_id parameters.</span>';

        setTimeout(() => {
          alert('QR Code Content:\n' + decodedText + '\n\nExpected format:\nhttps://yoursite.com/vip?bar_owner=X&bar_id=Y');
        }, 500);
      }
    },
    (errorMessage) => {
      console.log('Scanner error:', errorMessage);
    }
  ).then(() => {
    document.getElementById('scanStatus').innerText = 'üîç Point camera at QR code';
  }).catch((err) => {
    console.error('Scanner start error:', err);
    document.getElementById('scanStatus').innerHTML = '<span style="color:#dc2626;">‚ùå Camera access denied. Please allow camera permissions.</span>';
  });
}

function cancelScan() {
  if (qrScanner) {
    try { qrScanner.stop(); } catch (e) {}
    qrScanner = null;
  }
  checkPassStatus();
}

// ============================================
// FIX 2: logVisit ‚Äî per-bar daily duplicate check
// FIX 3: increments per-owner count
// ============================================
async function logVisit(barOwnerID, barID) {
  const now = Date.now();

  if (!currentState.visitsByOwner) currentState.visitsByOwner = {};
  if (!currentState.lastVisitByBar) currentState.lastVisitByBar = {};

  const ownerID = barOwnerID || currentState.barOwnerID || 'unknown';

  // FIX 2: Only count punch if not a duplicate for this specific bar today
  if (!isDuplicateLocal(barID)) {
    currentState.visitsByOwner[ownerID] = (currentState.visitsByOwner[ownerID] || 0) + 1;
    currentState.lastVisitByBar[barID] = now;
  }

  currentState.lastScanTimestamp = now;
  currentState.lastScanBar = barID;

  // Update state so badge reflects scanned bar
  currentState.barOwnerID = ownerID;
  currentState.barID = barID;
  updateCardBadge();

  saveToLocalStorage();

  const formData = new URLSearchParams({
    type: 'LOG_VISIT',
    phone: currentState.phone,
    code: currentState.code,
    barOwnerID: ownerID,
    barID: barID || currentState.barID,
    timestamp: now
  });

  fetch(GOOGLE_SCRIPT_URL, {
    method: 'POST',
    body: formData
  }).catch(err => console.log('Background sync failed:', err));

  showActivePass();
}

// ============================================
// FIX 2: isDuplicateLocal ‚Äî per-bar calendar day
// ============================================
function isDuplicateLocal(barID) {
  const today = new Date().toDateString();
  const lastVisitTime = localStorage.getItem('vip_last_visit_' + barID);
  if (!lastVisitTime) return false;
  return new Date(parseInt(lastVisitTime)).toDateString() === today;
}

// ============================================
// UTILITIES
// ============================================
function formatPhone(phone) {
  const cleaned = (phone || '').replace(/\D/g, '');
  const match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/);
  return match ? `(${match[1]}) ${match[2]}-${match[3]}` : phone;
}
</script>

<div style="position:fixed; bottom:12px; right:12px; z-index:9999;">
  <a href="https://thestrandvip.com/wp-content/uploads/2026/02/version3ownerportal.html?v=1" style="display:inline-block; padding:8px 14px; background:rgba(0,0,0,0.4); color:rgba(255,255,255,0.7); font-size:11px; font-family:sans-serif; border-radius:20px; text-decoration:none; border:1px solid rgba(255,255,255,0.2);">Owner Login</a>
</div>

</body>
</html>
