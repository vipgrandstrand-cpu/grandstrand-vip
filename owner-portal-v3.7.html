<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="data:,">
<title>Grand Strand VIP - Owner Portal</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

html {
  min-height: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

body {
  width: 100%;
  min-height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding: 20px;
  margin: 0;
  overflow-y: auto;
  box-sizing: border-box;
}

.container {
  background: white;
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  max-width: 600px;
  width: 100%;
  padding: 40px;
}

.logo {
  text-align: center;
  margin-bottom: 30px;
}

.logo h1 {
  font-size: 28px;
  font-weight: 700;
  color: #667eea;
  margin-bottom: 5px;
}

.logo p {
  font-size: 14px;
  color: #666;
}

.hidden { display: none !important; }

.form-group { margin-bottom: 12px; }

label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #333;
  margin-bottom: 8px;
}

input[type="text"],
input[type="password"] {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 15px;
  transition: border-color 0.2s;
}

input[type="text"]:focus,
input[type="password"]:focus {
  outline: none;
  border-color: #667eea;
}

.btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary { background: #667eea; color: white; }
.btn-primary:hover { background: #5568d3; }
.btn-primary:disabled { background: #ccc; cursor: not-allowed; }
.btn-secondary { background: #f0f0f0; color: #333; margin-top: 10px; }
.btn-secondary:hover { background: #e0e0e0; }
.btn-warning { background: #ff9800; color: white; margin-top: 0; }
.btn-warning:hover { background: #e68900; }

.owner-info {
  background: #f8f9fa;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 24px;
}

.owner-info h2 { font-size: 20px; color: #333; margin-bottom: 8px; }
.owner-info p { font-size: 14px; color: #666; margin: 4px 0; }

.upload-area {
  border: 3px dashed #667eea;
  border-radius: 12px;
  padding: 40px;
  text-align: center;
  background: #f8f9ff;
  margin-bottom: 20px;
  cursor: pointer;
  transition: all 0.2s;
}

.upload-area:hover { background: #f0f3ff; border-color: #5568d3; }
.upload-area.dragover { background: #e8ecff; border-color: #5568d3; }
.upload-icon { font-size: 32px; margin-bottom: 8px; }
.upload-text { font-size: 16px; color: #667eea; font-weight: 600; margin-bottom: 8px; }
.upload-hint { font-size: 13px; color: #999; }

.file-info {
  background: #e8f5e9;
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.file-info span { font-size: 14px; color: #2e7d32; font-weight: 600; }
.file-info button { background: none; border: none; color: #d32f2f; cursor: pointer; font-size: 14px; font-weight: 600; }

.sync-warning {
  background: #fff8e1;
  border: 2px solid #ff9800;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
}

.sync-warning h3 { font-size: 15px; color: #e65100; margin-bottom: 8px; }
.sync-warning p { font-size: 13px; color: #bf360c; margin: 4px 0; line-height: 1.5; }

.sync-actions { display: flex; gap: 10px; margin-top: 14px; }
.sync-actions .btn { flex: 1; padding: 10px; font-size: 14px; margin-top: 0; }

.results { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-top: 24px; }

.result-item {
  display: flex;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid #e0e0e0;
}

.result-item:last-child { border-bottom: none; }
.result-icon { font-size: 24px; margin-right: 12px; }
.result-text { flex: 1; }
.result-label { font-size: 13px; color: #666; margin-bottom: 2px; }
.result-value { font-size: 18px; font-weight: 700; color: #333; }

.success { color: #4caf50; }
.error { color: #f44336; }
.warning { color: #ff9800; }

.alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
.alert-error { background: #ffebee; color: #c62828; border-left: 4px solid #f44336; }
.alert-success { background: #e8f5e9; color: #2e7d32; border-left: 4px solid #4caf50; }

.spinner {
  border: 3px solid #f0f0f0;
  border-top: 3px solid #667eea;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  animation: spin 1s linear infinite;
  display: inline-block;
  margin-right: 8px;
  vertical-align: middle;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>
<body>

<div class="page-wrapper"><div class="container">
  <div class="logo">
    <h1>Grand Strand VIP</h1>
    <p>Owner Portal</p>
    <p style="font-size:11px; color:#bbb; margin-top:4px;">v3.7.6</p>
  </div>

  <!-- LOGIN VIEW -->
  <div id="viewLogin">
    <div class="form-group">
      <label>Owner ID</label>
      <input type="text" id="ownerID" placeholder="e.g., johns-bars">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="password" placeholder="Enter your password">
    </div>
    <button class="btn btn-primary" id="loginBtn">Login</button>
    <div id="loginError" class="alert alert-error hidden" style="margin-top:16px;"></div>
  </div>

  <!-- UPLOAD VIEW -->
  <div id="viewUpload" class="hidden">
    <div class="owner-info">
      <h2 id="ownerName">Owner Name</h2>
      <p><strong>Owner ID:</strong> <span id="displayOwnerID"></span></p>
      <p><strong>Locations:</strong> <span id="displayBarIDs"></span></p>
      <p><strong>Last CSV Sync:</strong> <span id="displayLastSync">Never</span></p>
    </div>

    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">&#128202;</div>
      <div class="upload-text">Click or drag CSV file here</div>
      <div class="upload-hint">POS export file (CSV format)</div>
    </div>

    <input type="file" id="fileInput" accept=".csv" style="display:none;">

    <div id="fileInfo" class="file-info hidden">
      <span id="fileName"></span>
      <button id="clearFileBtn">Remove</button>
    </div>

    <div id="syncWarning" class="sync-warning hidden">
      <h3>Please Confirm Before Uploading</h3>
      <p id="syncWarningLastSync"></p>
      <p id="syncWarningFileRange"></p>
      <p style="margin-top:8px;font-weight:600;">Do you want to continue with this upload?</p>
      <div class="sync-actions">
        <button class="btn btn-warning" id="confirmUploadBtn">Yes, Upload Anyway</button>
        <button class="btn btn-secondary" id="cancelUploadBtn">Cancel</button>
      </div>
    </div>

    <button class="btn btn-primary" id="uploadBtn" disabled>Process and Upload</button>
    <button class="btn btn-secondary" id="logoutBtn">Logout</button>
    <div id="uploadResults" class="results hidden"></div>
  </div>
</div>

<script>
var BACKEND_URL = "https://script.google.com/macros/s/AKfycbx5A_LYlaGPiXsHuBxEWpsB5pF9_GCB8xrEclxpm2ieoK6zf_VRm9EzbnIZNJz8hmpVsQ/exec";

var currentSession = { ownerID: null, ownerName: null, barIDs: null, lastCSVSync: null, barSyncs: {} };
var selectedFile = null;
var parsedTransactions = null;
var parsedRejected = null;
var parsedTotal = null;
var isUploading = false; // Global lock prevents any double submission
var staleConfirmed = false; // Set to true after user confirms stale warning

// Attach events directly - no waiting for DOMContentLoaded
function init() {
  document.getElementById('loginBtn').onclick = handleLogin;
  document.getElementById('uploadArea').onclick = function() { document.getElementById('fileInput').click(); };
  document.getElementById('fileInput').onchange = handleFileSelect;
  document.getElementById('clearFileBtn').onclick = clearFile;
  document.getElementById('uploadBtn').onclick = processAndUpload;
  document.getElementById('logoutBtn').onclick = handleLogout;
  document.getElementById('confirmUploadBtn').onclick = confirmUpload;
  document.getElementById('cancelUploadBtn').onclick = cancelUpload;

  var uploadArea = document.getElementById('uploadArea');
  uploadArea.ondragover = function(e) { e.preventDefault(); uploadArea.classList.add('dragover'); };
  uploadArea.ondragleave = function() { uploadArea.classList.remove('dragover'); };
  uploadArea.ondrop = function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    var file = e.dataTransfer.files[0];
    if (file && file.name.endsWith('.csv')) {
      selectedFile = file;
      document.getElementById('fileName').innerText = file.name;
      document.getElementById('fileInfo').classList.remove('hidden');
      document.getElementById('uploadBtn').disabled = false;
    } else {
      alert('Please drop a valid CSV file');
    }
  };
}

// Run init once when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

// ============================================
// LOGIN
// ============================================
async function handleLogin() {
  var ownerID = document.getElementById('ownerID').value.trim();
  var password = document.getElementById('password').value.trim();
  var loginBtn = document.getElementById('loginBtn');

  document.getElementById('loginError').classList.add('hidden');

  if (!ownerID || !password) {
    showLoginError('Please enter both Owner ID and Password');
    return;
  }

  loginBtn.disabled = true;
  loginBtn.innerHTML = '<span class="spinner"></span>Logging in...';

  try {
    var loginData = new URLSearchParams({ type: 'VALIDATE_OWNER', ownerID: ownerID, password: password });
    var response = await fetch(BACKEND_URL, { method: 'POST', body: loginData });
    var data = await response.json();

    if (data.status === 'SUCCESS') {
      currentSession.ownerID = data.owner.ownerID;
      currentSession.ownerName = data.owner.ownerName;
      currentSession.barIDs = data.owner.barIDs;
      currentSession.lastCSVSync = data.owner.lastCSVSync || null;
      currentSession.barSyncs = {};

      // Fetch per-bar sync timestamps
      try {
        var syncData = new URLSearchParams({ type: 'GET_BAR_SYNCS', ownerID: data.owner.ownerID });
        var syncResp = await fetch(BACKEND_URL, { method: 'POST', body: syncData });
        var syncResult = await syncResp.json();
        if (syncResult.status === 'SUCCESS') {
          currentSession.barSyncs = syncResult.barSyncs || {};
        }
      } catch (e) {
        console.log('Bar sync fetch failed:', e.message);
      }

      document.getElementById('ownerName').innerText = data.owner.ownerName;
      document.getElementById('displayOwnerID').innerText = data.owner.ownerID;
      document.getElementById('displayBarIDs').innerText = data.owner.barIDs;
      document.getElementById('displayLastSync').innerText = data.owner.lastCSVSync ? formatDate(data.owner.lastCSVSync) : 'Never';

      document.getElementById('viewLogin').classList.add('hidden');
      document.getElementById('viewUpload').classList.remove('hidden');
    } else {
      showLoginError(data.message || 'Invalid credentials');
      loginBtn.disabled = false;
      loginBtn.innerText = 'Login';
    }
  } catch (err) {
    showLoginError('Connection error. Please try again.');
    loginBtn.disabled = false;
    loginBtn.innerText = 'Login';
  }
}

function showLoginError(message) {
  var errorDiv = document.getElementById('loginError');
  errorDiv.innerText = message;
  errorDiv.classList.remove('hidden');
}

function handleLogout() {
  currentSession = { ownerID: null, ownerName: null, barIDs: null, lastCSVSync: null, barSyncs: {} };
  selectedFile = null;
  parsedTransactions = null;
  document.getElementById('viewUpload').classList.add('hidden');
  document.getElementById('viewLogin').classList.remove('hidden');
  document.getElementById('ownerID').value = '';
  document.getElementById('password').value = '';
  document.getElementById('syncWarning').classList.add('hidden');
  clearFile();
}

// ============================================
// FILE HANDLING
// ============================================
function handleFileSelect(event) {
  var file = event.target.files[0];
  if (!file) return;
  if (!file.name.endsWith('.csv')) {
    alert('Please select a valid CSV file');
    return;
  }
  // Store file but do NOT auto-process - wait for button click
  selectedFile = file;
  parsedTransactions = null;
  parsedRejected = null;
  parsedTotal = null;
  document.getElementById('fileName').innerText = file.name;
  document.getElementById('fileInfo').classList.remove('hidden');
  document.getElementById('uploadBtn').disabled = false;
  document.getElementById('uploadBtn').innerText = 'Process and Upload';
  document.getElementById('uploadResults').classList.add('hidden');
  document.getElementById('syncWarning').classList.add('hidden');
}

function clearFile() {
  selectedFile = null;
  parsedTransactions = null;
  parsedRejected = null;
  parsedTotal = null;
  document.getElementById('fileInput').value = '';
  document.getElementById('fileInfo').classList.add('hidden');
  document.getElementById('uploadBtn').disabled = true;
  document.getElementById('uploadResults').classList.add('hidden');
  document.getElementById('syncWarning').classList.add('hidden');
  staleConfirmed = false;
}

// ============================================
// CSV PROCESSING
// ============================================
async function processAndUpload() {
  if (!selectedFile) return;
  // Guard against double firing
  var uploadBtn = document.getElementById('uploadBtn');
  if (uploadBtn.disabled) return;
  uploadBtn.disabled = true;
  uploadBtn.innerHTML = '<span class="spinner"></span>Processing...';

  try {
    var text = await selectedFile.text();
    var lines = text.split('\n').filter(function(line) { return line.trim(); });

    if (lines.length < 2) throw new Error('CSV file is empty or invalid');

    var headers = parseCSVLine(lines[0]);
    var transactions = [];
    var rejected = [];

    var notesIdx = -1, txnIdIdx = -1, locIdIdx = -1, totalIdx = -1, dateIdx = -1;

    for (var h = 0; h < headers.length; h++) {
      var lower = headers[h].toLowerCase();
      if (lower.indexOf('notes') !== -1) notesIdx = h;
      if ((lower.indexOf('transaction') !== -1 && lower.indexOf('id') !== -1) || lower === 'txn_id' || lower === 'txnid' || lower === 'trans_id') txnIdIdx = h;
      if ((lower.indexOf('location') !== -1 && lower.indexOf('id') !== -1) || lower === 'loc_id' || lower === 'locid' || lower === 'store_id') locIdIdx = h;
      if (lower.indexOf('total') !== -1 || lower.indexOf('amount') !== -1 || lower === 'price') totalIdx = h;
      if (lower.indexOf('date') !== -1 || lower.indexOf('time') !== -1) dateIdx = h;
    }

    if (notesIdx === -1 || txnIdIdx === -1 || locIdIdx === -1 || totalIdx === -1) {
      throw new Error('Required columns not found. Need: Notes, Transaction ID, Location ID, Transaction Total. Found: ' + headers.join(', '));
    }

    var earliestDate = null;
    var latestDate = null;

    for (var i = 1; i < lines.length; i++) {
      var values = parseCSVLine(lines[i]);
      if (values.length < headers.length) continue;

      var code = values[notesIdx] ? values[notesIdx].trim() : '';
      var txnID = values[txnIdIdx] ? values[txnIdIdx].trim() : '';
      var locID = values[locIdIdx] ? values[locIdIdx].trim() : '';
      var total = values[totalIdx] ? values[totalIdx].trim() : '';

      if (dateIdx !== -1 && values[dateIdx]) {
        var d = new Date(values[dateIdx]);
        if (!isNaN(d)) {
          if (!earliestDate || d < earliestDate) earliestDate = d;
          if (!latestDate || d > latestDate) latestDate = d;
        }
      }

      var codeRegex = /^[A-Za-z]\d{4}$/;
      if (codeRegex.test(code)) {
        transactions.push({ code: code.toUpperCase(), transactionID: txnID, locationID: locID, transactionTotal: parseFloat(total) || 0 });
      } else {
        rejected.push({ row: i + 1, code: code });
      }
    }

    parsedTransactions = transactions;
    parsedRejected = rejected;
    parsedTotal = lines.length - 1;

    // Per-bar stale check — each bar checked independently
    var staleWarnings = [];
    var barsInFile = {};

    // Collect unique bar IDs from valid transactions
    for (var ti = 0; ti < transactions.length; ti++) {
      var bid = String(transactions[ti].locationID || '').trim().toLowerCase();
      if (bid) barsInFile[bid] = true;
    }

    for (var barID in barsInFile) {
      var barLastSync = currentSession.barSyncs[barID] ? new Date(currentSession.barSyncs[barID]) : null;
      if (barLastSync && latestDate && latestDate < barLastSync) {
        staleWarnings.push(barID + ' (last synced: ' + formatDate(barLastSync) + ')');
      }
    }

    if (staleWarnings.length > 0 && !staleConfirmed) {
      document.getElementById('syncWarningLastSync').innerText = 'Stale data detected for: ' + staleWarnings.join(', ');
      document.getElementById('syncWarningFileRange').innerText = 'This file contains transactions from ' + formatDate(earliestDate) + ' to ' + formatDate(latestDate) + ' - which appears older than your last sync for one or more bars.';
      document.getElementById('syncWarning').classList.remove('hidden');
      uploadBtn.disabled = true;
      uploadBtn.innerText = 'Process and Upload';
      return;
    }

    await uploadTransactions(parsedTransactions, parsedRejected.length, parsedTotal);

  } catch (err) {
    showUploadResults({ success: false, error: err.message });
    uploadBtn.disabled = false;
    uploadBtn.innerText = 'Process and Upload';
  }
}

function confirmUpload() {
  // Dismiss warning, set confirmed flag, re-enable button
  staleConfirmed = true;
  document.getElementById('syncWarning').classList.add('hidden');
  var uploadBtn = document.getElementById('uploadBtn');
  uploadBtn.disabled = false;
  uploadBtn.innerText = 'Process and Upload';
}

function cancelUpload() {
  document.getElementById('syncWarning').classList.add('hidden');
  clearFile();
  // clearFile already disables button, nothing else needed
}

// ============================================
// UPLOAD TO GRAND STRAND
// ============================================
async function uploadTransactions(transactions, rejectedCount, totalCount) {
  // Global lock — only one upload at a time
  if (isUploading) {
    console.log('Upload already in progress — ignoring duplicate call');
    return;
  }
  isUploading = true;

  var formData = new URLSearchParams({
    type: 'UPLOAD_POS_DATA',
    ownerID: currentSession.ownerID,
    transactions: JSON.stringify(transactions)
  });

  try {
    console.log('STEP 1: Starting fetch');
    // 25 second timeout for large CSV uploads
    var controller = new AbortController();
    var timeout = setTimeout(function() { controller.abort(); }, 25000);
    var response = await fetch(BACKEND_URL, { method: 'POST', body: formData, signal: controller.signal });
    console.log('STEP 2: Fetch returned, status:', response.status);
    clearTimeout(timeout);
    var rawText = await response.text();
    console.log('STEP 3: Got text length:', rawText.length);
    console.log('STEP 4: Preview:', rawText.substring(0, 300));
    var result = JSON.parse(rawText);
    console.log('STEP 5: Parsed, status:', result.status);

    if (result.status === 'SUCCESS') {
      if (result.lastSync) {
        currentSession.lastCSVSync = result.lastSync;
        document.getElementById('displayLastSync').innerText = formatDate(new Date(result.lastSync));
      }
      // Refresh bar syncs separately in background
      try {
        var syncData = new URLSearchParams({ type: 'GET_BAR_SYNCS', ownerID: currentSession.ownerID });
        var syncResp = await fetch(BACKEND_URL, { method: 'POST', body: syncData });
        var syncResult = await syncResp.json();
        if (syncResult.status === 'SUCCESS') currentSession.barSyncs = syncResult.barSyncs || {};
      } catch(e) {}
      showUploadResults({ success: true, uploaded: transactions.length, rejected: rejectedCount, total: totalCount, matched: result.matched || 0, unmatched: result.unmatched || 0 });
      isUploading = false;
      clearFile();
      selectedFile = null;
      parsedTransactions = null;
    } else {
      showUploadResults({ success: false, error: result.message || 'Upload failed' });
      isUploading = false;
      document.getElementById('uploadBtn').disabled = false;
      document.getElementById('uploadBtn').innerText = 'Process and Upload';
    }
  } catch (err) {
    var msg = err.name === 'AbortError'
      ? 'Upload timed out after 25 seconds. Your data may have been processed — check your dashboard before trying again.'
      : 'Failed to upload: ' + err.message;
    showUploadResults({ success: false, error: msg });
    isUploading = false;
    document.getElementById('uploadBtn').disabled = false;
    document.getElementById('uploadBtn').innerText = 'Process and Upload';
  }
}

// ============================================
// RESULTS
// ============================================
function showUploadResults(data) {
  var resultsDiv = document.getElementById('uploadResults');
  resultsDiv.classList.remove('hidden');

  if (!data.success) {
    resultsDiv.innerHTML = '<div class="alert alert-error"><strong>Upload Failed</strong><br>' + (data.error || 'Unknown error') + '</div>';
    return;
  }

  resultsDiv.innerHTML =
    '<div class="alert alert-success"><strong>Upload Complete!</strong><br>Your dashboard will update shortly.</div>' +
    '<div class="result-item"><div class="result-text"><div class="result-label">Total Rows in CSV</div><div class="result-value">' + data.total + '</div></div></div>' +
    '<div class="result-item"><div class="result-text"><div class="result-label">Valid VIP Transactions</div><div class="result-value success">' + data.uploaded + '</div></div></div>' +
    '<div class="result-item"><div class="result-text"><div class="result-label">Matched to VIP Customers</div><div class="result-value success">' + data.matched + '</div></div></div>' +
    '<div class="result-item"><div class="result-text"><div class="result-label">Rejected (Invalid Codes)</div><div class="result-value error">' + data.rejected + '</div></div></div>' +
    '<div class="result-item"><div class="result-text"><div class="result-label">Unmatched VIP Codes</div><div class="result-value warning">' + data.unmatched + '</div></div></div>';
}

// ============================================
// HELPERS
// ============================================
function parseCSVLine(line) {
  var result = [];
  var current = '';
  var inQuotes = false;
  for (var i = 0; i < line.length; i++) {
    var char = line[i];
    if (char === '"') { inQuotes = !inQuotes; }
    else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
    else { current += char; }
  }
  result.push(current.trim());
  return result;
}

function formatDate(date) {
  if (!date) return 'Never';
  var d = new Date(date);
  if (isNaN(d)) return 'Never';
  return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}
</script>
</body>
</html>
